name: vps-claude-integration-test

services:
  # PostgreSQL (port offset to avoid dev conflicts)
  postgres:
    image: postgres:16-alpine
    container_name: test-vps-postgres
    environment:
      POSTGRES_DB: vps-claude-test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: test-password
    ports:
      - "54326:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - test-vps-internal
    volumes:
      - postgres-data:/var/lib/postgresql/data

  # Redis (port offset)
  redis:
    image: redis:7-alpine
    container_name: test-vps-redis
    ports:
      - "63834:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - test-vps-internal
    volumes:
      - redis-data:/data

  # API Server
  server:
    build:
      context: ../../..
      dockerfile: apps/server/Dockerfile
    container_name: test-vps-server
    ports:
      - "33010:33000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - /tmp/vps-test-boxes:/mnt/devboxes:rw
    environment:
      - DATABASE_URL=postgresql://postgres:test-password@postgres:5432/vps-claude-test
      - REDIS_URL=redis://redis:6379
      - BETTER_AUTH_SECRET=test-auth-secret-32-chars-minimum-length
      - INTERNAL_API_KEY=test-internal-key-32-chars-minimum-length
      - BOX_BASE_IMAGE=box-test-ssh:latest
      - APP_ENV=test
      - NODE_ENV=test
      - INBOUND_EMAIL_API_KEY=test-email-key
      - AGENTS_DOMAIN=test.local
      - CORS_ORIGIN=http://localhost:3000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - test-vps-internal
      - traefik-test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:33000/health"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 15s

  # Traefik (HTTP only, no TLS)
  traefik:
    image: traefik:v3.0
    container_name: test-vps-traefik
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=traefik-test"
      - "--entrypoints.web.address=:80"
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "8090:80"
      - "8091:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - traefik-test
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    depends_on:
      - server

  # SSH Bastion
  ssh-bastion:
    build:
      context: ../../..
      dockerfile: packages/ssh-bastion/Dockerfile
    container_name: test-vps-ssh-bastion
    ports:
      - "2222:22"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - sshpiper-workdir:/etc/sshpiper/workingdir
    environment:
      - API_URL=http://server:33000
      - INTERNAL_API_KEY=test-internal-key-32-chars-minimum-length
      - SYNC_INTERVAL_MS=5000
      - WORKDIR=/etc/sshpiper/workingdir
    depends_on:
      server:
        condition: service_healthy
    networks:
      - test-vps-internal
      - traefik-test
    healthcheck:
      test: ["CMD", "pgrep", "-f", "sshpiperd"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

networks:
  test-vps-internal:
    driver: bridge
  traefik-test:
    driver: bridge
    name: traefik-test

volumes:
  postgres-data:
  redis-data:
  sshpiper-workdir:
